/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// main.ts
var main_exports = {};
__export(main_exports, {
  default: () => TagFlowPlugin
});
module.exports = __toCommonJS(main_exports);
var import_obsidian = require("obsidian");
var DeleteListModal = class extends import_obsidian.FuzzySuggestModal {
  constructor(app, plugin) {
    super(app);
    this.plugin = plugin;
  }
  getItems() {
    const activeView = this.app.workspace.getActiveViewOfType(import_obsidian.MarkdownView);
    return activeView ? this.plugin.lists.filter((list) => list.notePath === activeView.file.path) : [];
  }
  getItemText(item) {
    console.log("Item ID:", item.id);
    return `${item.tag} (ID: ${item.id})`;
  }
  onChooseItem(item) {
    this.plugin.deleteList(item);
  }
};
var TagSuggester = class extends import_obsidian.FuzzySuggestModal {
  constructor(app, plugin, tags) {
    super(app);
    this.tags = tags;
    this.plugin = plugin;
  }
  getItems() {
    return this.tags;
  }
  getItemText(item) {
    return item;
  }
  onChooseItem(item) {
    this.plugin.handleTagSelection(item);
  }
};
var TagFlowPlugin = class extends import_obsidian.Plugin {
  constructor() {
    super(...arguments);
    this.allTags = [];
    this.lists = [];
  }
  async onload() {
    console.log("Plugin loaded");
    this.allTags = await this.fetchAllTags();
    this.registerCodeMirror((cm) => {
      cm.on("change", this.handleFileChange.bind(this));
    });
    this.addCommand({
      id: "delete-current-list",
      name: "Delete Current List",
      callback: () => new DeleteListModal(this.app, this).open()
    });
    this.addCommand({
      id: "open-tag-flow",
      name: "Open Tag Flow",
      callback: () => this.createTagList()
    });
    this.app.workspace.on("active-leaf-change", () => {
      this.updateLists();
    });
    this.app.workspace.on("layout-change", () => {
      if (this.app.workspace.getLeavesOfType("graph").length > 0) {
        this.updateLists();
      }
    });
    setInterval(() => {
      this.updateLists();
    }, 60 * 60 * 1e3);
    this.app.workspace.onLayoutReady(() => {
      this.loadData();
    });
    this.updateLists();
  }
  async deleteList(list) {
    let note = this.app.vault.getAbstractFileByPath(list.notePath);
    let content = await this.app.vault.read(note);
    const startAnchor = `<!--tag-list ${list.tag} ${list.id}-->`;
    const endAnchor = `<!--end-tag-list ${list.tag} ${list.id}-->`;
    const startIndex = content.indexOf(startAnchor);
    const endIndex = content.indexOf(endAnchor);
    if (startIndex >= 0) {
      if (endIndex >= 0) {
        content = content.substring(0, startIndex) + content.substring(endIndex + endAnchor.length);
      } else {
        const nextLineIndex = content.indexOf("\n", startIndex);
        content = content.substring(0, startIndex) + content.substring(nextLineIndex + 1);
      }
      await this.app.vault.modify(note, content);
      this.lists = this.lists.filter((l) => l !== list);
      await this.saveData();
    }
  }
  async fetchAllTags() {
    const allTags = /* @__PURE__ */ new Set();
    for (const file of this.app.vault.getMarkdownFiles()) {
      const fileContent = await this.app.vault.cachedRead(file);
      const tagRegex = /#([a-zA-Z0-9_-]+)/g;
      let match;
      while (match = tagRegex.exec(fileContent)) {
        allTags.add(match[1]);
      }
    }
    return Array.from(allTags);
  }
  async createTagList() {
    this.allTags = await this.fetchAllTags();
    if (this.allTags.length > 0) {
      new TagSuggester(this.app, this, this.allTags).open();
    }
  }
  async handleTagSelection(tag) {
    const activeView = this.app.workspace.getActiveViewOfType(import_obsidian.MarkdownView);
    if (activeView) {
      const activeEditor = activeView.editor;
      const cursor = activeEditor.getCursor();
      const id = Date.now();
      activeEditor.replaceRange(`<!--tag-list #${tag} ${id}-->
<!--end-tag-list #${tag} ${id}-->
`, cursor);
      this.lists.push({
        tag: `#${tag}`,
        notePath: activeView.file.path,
        id
      });
      await this.updateLists();
      await this.saveData();
    }
  }
  async handleFileChange(change) {
    const file = this.app.vault.getAbstractFileByPath(change.doc.file.path);
    if (file instanceof import_obsidian.TFile) {
      this.allTags = await this.fetchAllTags();
      const content = await this.app.vault.read(file);
      if (content.includes("<!--tag-list")) {
        await this.updateLists();
      }
    }
  }
  async updateLists() {
    if (!this.lists.length) {
      return;
    }
    for (let list of this.lists) {
      const filesWithTag = (await Promise.all(
        this.app.vault.getMarkdownFiles().map(async (file) => {
          const content2 = await this.app.vault.read(file);
          return content2.includes(list.tag) ? file : null;
        })
      )).filter(Boolean);
      const links = filesWithTag.map((file) => `[[${file.basename}]]`).join("\n");
      let note = this.app.vault.getAbstractFileByPath(list.notePath);
      let content = await this.app.vault.read(note);
      const startAnchor = `<!--tag-list ${list.tag} ${list.id}-->`;
      const endAnchor = `<!--end-tag-list ${list.tag} ${list.id}-->`;
      const startIndex = content.indexOf(startAnchor);
      const endIndex = content.indexOf(endAnchor);
      if (startIndex >= 0) {
        if (endIndex >= 0) {
          content = content.substring(0, startIndex) + startAnchor + "\n" + links + "\n" + endAnchor + content.substring(endIndex + endAnchor.length);
        } else {
          content = content.substring(0, startIndex) + startAnchor + "\n" + links + "\n" + endAnchor + content.substring(startIndex + startAnchor.length);
        }
        await this.app.vault.modify(note, content);
      }
    }
  }
  async saveData() {
    const data = {
      lists: this.lists.map((list) => ({ tag: list.tag, notePath: list.notePath, id: list.id }))
    };
  }
  async loadData() {
    try {
      const content = await this.app.vault.adapter.read("tagFlowData.json");
      const data = JSON.parse(content);
      this.lists = data.lists.map((listData) => ({ tag: listData.tag, notePath: listData.notePath, id: listData.id }));
    } catch (error) {
      console.error("Failed to load data:", error);
    }
  }
  onunload() {
    console.log("unloading plugin");
  }
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsibWFpbi50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgQXBwLCBQbHVnaW4sIE1hcmtkb3duVmlldywgRnV6enlTdWdnZXN0TW9kYWwsIFRGaWxlLCBNb2RhbCwgTm90aWNlIH0gZnJvbSAnb2JzaWRpYW4nO1xuXG5pbnRlcmZhY2UgVGFnTGlzdCB7XG4gIHRhZzogc3RyaW5nO1xuICBub3RlUGF0aDogc3RyaW5nO1xuICBpZDogbnVtYmVyOyAgLy8gVGltZXN0YW1wIHdoZW4gdGhlIGxpc3Qgd2FzIGNyZWF0ZWRcbn1cblxuY2xhc3MgRGVsZXRlTGlzdE1vZGFsIGV4dGVuZHMgRnV6enlTdWdnZXN0TW9kYWw8VGFnTGlzdD4ge1xuICBwbHVnaW46IFRhZ0Zsb3dQbHVnaW47XG5cbiAgY29uc3RydWN0b3IoYXBwOiBBcHAsIHBsdWdpbjogVGFnRmxvd1BsdWdpbikge1xuICAgIHN1cGVyKGFwcCk7XG4gICAgdGhpcy5wbHVnaW4gPSBwbHVnaW47XG4gIH1cblxuICBnZXRJdGVtcygpOiBUYWdMaXN0W10ge1xuICAgIGNvbnN0IGFjdGl2ZVZpZXcgPSB0aGlzLmFwcC53b3Jrc3BhY2UuZ2V0QWN0aXZlVmlld09mVHlwZShNYXJrZG93blZpZXcpO1xuICAgIHJldHVybiBhY3RpdmVWaWV3ID8gdGhpcy5wbHVnaW4ubGlzdHMuZmlsdGVyKGxpc3QgPT4gbGlzdC5ub3RlUGF0aCA9PT0gYWN0aXZlVmlldy5maWxlLnBhdGgpIDogW107XG4gIH1cblxuICBnZXRJdGVtVGV4dChpdGVtOiBUYWdMaXN0KTogc3RyaW5nIHtcbiAgICBjb25zb2xlLmxvZyhcIkl0ZW0gSUQ6XCIsIGl0ZW0uaWQpO1xuICAgIHJldHVybiBgJHtpdGVtLnRhZ30gKElEOiAke2l0ZW0uaWR9KWA7ICBcbiAgfVxuXG4gIG9uQ2hvb3NlSXRlbShpdGVtOiBUYWdMaXN0KSB7XG4gICAgdGhpcy5wbHVnaW4uZGVsZXRlTGlzdChpdGVtKTtcbiAgfVxufVxuXG5jbGFzcyBUYWdTdWdnZXN0ZXIgZXh0ZW5kcyBGdXp6eVN1Z2dlc3RNb2RhbDxzdHJpbmc+IHtcbiAgdGFnczogc3RyaW5nW107XG4gIHBsdWdpbjogVGFnRmxvd1BsdWdpbjtcblxuICBjb25zdHJ1Y3RvcihhcHA6IEFwcCwgcGx1Z2luOiBUYWdGbG93UGx1Z2luLCB0YWdzOiBzdHJpbmdbXSkge1xuICAgIHN1cGVyKGFwcCk7XG4gICAgdGhpcy50YWdzID0gdGFncztcbiAgICB0aGlzLnBsdWdpbiA9IHBsdWdpbjtcbiAgfVxuXG4gIGdldEl0ZW1zKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gdGhpcy50YWdzO1xuICB9XG5cbiAgZ2V0SXRlbVRleHQoaXRlbTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gaXRlbTtcbiAgfVxuXG4gIG9uQ2hvb3NlSXRlbShpdGVtOiBzdHJpbmcpIHtcbiAgICB0aGlzLnBsdWdpbi5oYW5kbGVUYWdTZWxlY3Rpb24oaXRlbSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVGFnRmxvd1BsdWdpbiBleHRlbmRzIFBsdWdpbiB7XG4gIGFsbFRhZ3M6IHN0cmluZ1tdID0gW107XG4gIGxpc3RzOiBUYWdMaXN0W10gPSBbXTtcblxuICBhc3luYyBvbmxvYWQoKSB7XG4gICAgY29uc29sZS5sb2coXCJQbHVnaW4gbG9hZGVkXCIpO1xuICAgIHRoaXMuYWxsVGFncyA9IGF3YWl0IHRoaXMuZmV0Y2hBbGxUYWdzKCk7XG5cbiAgICB0aGlzLnJlZ2lzdGVyQ29kZU1pcnJvcigoY206IENvZGVNaXJyb3IuRWRpdG9yKSA9PiB7XG4gICAgICBjbS5vbihcImNoYW5nZVwiLCB0aGlzLmhhbmRsZUZpbGVDaGFuZ2UuYmluZCh0aGlzKSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLmFkZENvbW1hbmQoe1xuICAgICAgaWQ6ICdkZWxldGUtY3VycmVudC1saXN0JyxcbiAgICAgIG5hbWU6ICdEZWxldGUgQ3VycmVudCBMaXN0JyxcbiAgICAgIGNhbGxiYWNrOiAoKSA9PiBuZXcgRGVsZXRlTGlzdE1vZGFsKHRoaXMuYXBwLCB0aGlzKS5vcGVuKClcbiAgICB9KTtcblxuICAgIHRoaXMuYWRkQ29tbWFuZCh7XG4gICAgICBpZDogJ29wZW4tdGFnLWZsb3cnLFxuICAgICAgbmFtZTogJ09wZW4gVGFnIEZsb3cnLFxuICAgICAgY2FsbGJhY2s6ICgpID0+IHRoaXMuY3JlYXRlVGFnTGlzdCgpXG4gICAgfSk7XG5cbiAgICB0aGlzLmFwcC53b3Jrc3BhY2Uub24oJ2FjdGl2ZS1sZWFmLWNoYW5nZScsICgpID0+IHtcbiAgICAgIHRoaXMudXBkYXRlTGlzdHMoKTtcbiAgICB9KTtcblxuICAgIHRoaXMuYXBwLndvcmtzcGFjZS5vbignbGF5b3V0LWNoYW5nZScsICgpID0+IHtcbiAgICAgIGlmICh0aGlzLmFwcC53b3Jrc3BhY2UuZ2V0TGVhdmVzT2ZUeXBlKCdncmFwaCcpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhpcy51cGRhdGVMaXN0cygpO1xuICAgICAgfVxuICAgIH0pOyAgICAgICAgXG5cbiAgICBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICB0aGlzLnVwZGF0ZUxpc3RzKCk7XG4gICAgfSwgNjAgKiA2MCAqIDEwMDApO1xuXG4gICAgdGhpcy5hcHAud29ya3NwYWNlLm9uTGF5b3V0UmVhZHkoKCkgPT4ge1xuICAgICAgdGhpcy5sb2FkRGF0YSgpO1xuICAgIH0pO1xuXG4gICAgdGhpcy51cGRhdGVMaXN0cygpO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlTGlzdChsaXN0OiBUYWdMaXN0KSB7XG4gICAgbGV0IG5vdGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgobGlzdC5ub3RlUGF0aCkgYXMgVEZpbGU7XG4gICAgbGV0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5yZWFkKG5vdGUpO1xuICAgIGNvbnN0IHN0YXJ0QW5jaG9yID0gYDwhLS10YWctbGlzdCAke2xpc3QudGFnfSAke2xpc3QuaWR9LS0+YDtcbiAgICBjb25zdCBlbmRBbmNob3IgPSBgPCEtLWVuZC10YWctbGlzdCAke2xpc3QudGFnfSAke2xpc3QuaWR9LS0+YDtcbiAgICBjb25zdCBzdGFydEluZGV4ID0gY29udGVudC5pbmRleE9mKHN0YXJ0QW5jaG9yKTtcbiAgICBjb25zdCBlbmRJbmRleCA9IGNvbnRlbnQuaW5kZXhPZihlbmRBbmNob3IpO1xuICAgIGlmIChzdGFydEluZGV4ID49IDApIHtcbiAgICAgICAgaWYgKGVuZEluZGV4ID49IDApIHtcbiAgICAgICAgICAgIC8vIElmIHRoZSBlbmQgYW5jaG9yIGV4aXN0cywgZGVsZXRlIHRoZSBjb250ZW50IGJldHdlZW4gc3RhcnQgYW5kIGVuZCBhbmNob3JzXG4gICAgICAgICAgICBjb250ZW50ID0gY29udGVudC5zdWJzdHJpbmcoMCwgc3RhcnRJbmRleCkgKyBjb250ZW50LnN1YnN0cmluZyhlbmRJbmRleCArIGVuZEFuY2hvci5sZW5ndGgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gSWYgdGhlIGVuZCBhbmNob3IgZG9lcyBub3QgZXhpc3QsIG9ubHkgZGVsZXRlIHRoZSBjb250ZW50IGZyb20gc3RhcnQgYW5jaG9yIHRvIHRoZSBuZXh0IGxpbmVcbiAgICAgICAgICAgIGNvbnN0IG5leHRMaW5lSW5kZXggPSBjb250ZW50LmluZGV4T2YoJ1xcbicsIHN0YXJ0SW5kZXgpO1xuICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnQuc3Vic3RyaW5nKDAsIHN0YXJ0SW5kZXgpICsgY29udGVudC5zdWJzdHJpbmcobmV4dExpbmVJbmRleCArIDEpO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0Lm1vZGlmeShub3RlLCBjb250ZW50KTtcblxuICAgICAgICAvLyBSZW1vdmUgdGhlIGxpc3QgZnJvbSB0aGUgcGx1Z2luJ3MgbGlzdHNcbiAgICAgICAgdGhpcy5saXN0cyA9IHRoaXMubGlzdHMuZmlsdGVyKGwgPT4gbCAhPT0gbGlzdCk7XG5cbiAgICAgICAgLy8gU2F2ZSB0aGUgZGF0YVxuICAgICAgICBhd2FpdCB0aGlzLnNhdmVEYXRhKCk7XG4gICAgfVxufVxuXG5cbiAgYXN5bmMgZmV0Y2hBbGxUYWdzKCkge1xuICAgIGNvbnN0IGFsbFRhZ3MgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBmb3IgKGNvbnN0IGZpbGUgb2YgdGhpcy5hcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpKSB7XG4gICAgICBjb25zdCBmaWxlQ29udGVudCA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNhY2hlZFJlYWQoZmlsZSk7XG4gICAgICBjb25zdCB0YWdSZWdleCA9IC8jKFthLXpBLVowLTlfLV0rKS9nO1xuICAgICAgbGV0IG1hdGNoO1xuICAgICAgd2hpbGUgKG1hdGNoID0gdGFnUmVnZXguZXhlYyhmaWxlQ29udGVudCkpIHtcbiAgICAgICAgYWxsVGFncy5hZGQobWF0Y2hbMV0pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gQXJyYXkuZnJvbShhbGxUYWdzKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVRhZ0xpc3QoKSB7XG4gICAgdGhpcy5hbGxUYWdzID0gYXdhaXQgdGhpcy5mZXRjaEFsbFRhZ3MoKTtcbiAgICBpZiAodGhpcy5hbGxUYWdzLmxlbmd0aCA+IDApIHtcbiAgICAgIG5ldyBUYWdTdWdnZXN0ZXIodGhpcy5hcHAsIHRoaXMsIHRoaXMuYWxsVGFncykub3BlbigpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGhhbmRsZVRhZ1NlbGVjdGlvbih0YWc6IHN0cmluZykge1xuICAgIGNvbnN0IGFjdGl2ZVZpZXcgPSB0aGlzLmFwcC53b3Jrc3BhY2UuZ2V0QWN0aXZlVmlld09mVHlwZShNYXJrZG93blZpZXcpO1xuICAgIGlmIChhY3RpdmVWaWV3KSB7XG4gICAgICAgIGNvbnN0IGFjdGl2ZUVkaXRvciA9IGFjdGl2ZVZpZXcuZWRpdG9yO1xuICAgICAgICBjb25zdCBjdXJzb3IgPSBhY3RpdmVFZGl0b3IuZ2V0Q3Vyc29yKCk7XG4gICAgICAgIGNvbnN0IGlkID0gRGF0ZS5ub3coKTtcbiAgICAgICAgYWN0aXZlRWRpdG9yLnJlcGxhY2VSYW5nZShgPCEtLXRhZy1saXN0ICMke3RhZ30gJHtpZH0tLT5cXG48IS0tZW5kLXRhZy1saXN0ICMke3RhZ30gJHtpZH0tLT5cXG5gLCBjdXJzb3IpO1xuICAgICAgICB0aGlzLmxpc3RzLnB1c2goe1xuICAgICAgICAgICAgdGFnOiBgIyR7dGFnfWAsXG4gICAgICAgICAgICBub3RlUGF0aDogYWN0aXZlVmlldy5maWxlLnBhdGgsXG4gICAgICAgICAgICBpZDogaWRcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlTGlzdHMoKTtcbiAgICAgICAgYXdhaXQgdGhpcy5zYXZlRGF0YSgpO1xuICAgIH1cbn1cblxuICBhc3luYyBoYW5kbGVGaWxlQ2hhbmdlKGNoYW5nZTogYW55KSB7XG4gICAgY29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChjaGFuZ2UuZG9jLmZpbGUucGF0aCk7XG4gICAgaWYgKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkge1xuICAgICAgdGhpcy5hbGxUYWdzID0gYXdhaXQgdGhpcy5mZXRjaEFsbFRhZ3MoKTtcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5yZWFkKGZpbGUpO1xuICAgICAgaWYgKGNvbnRlbnQuaW5jbHVkZXMoJzwhLS10YWctbGlzdCcpKSB7XG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlTGlzdHMoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuXG5cblxuICBhc3luYyB1cGRhdGVMaXN0cygpIHtcbiAgICBpZiAoIXRoaXMubGlzdHMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBsaXN0IG9mIHRoaXMubGlzdHMpIHtcbiAgICAgICAgY29uc3QgZmlsZXNXaXRoVGFnID0gKGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICAgICAgdGhpcy5hcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpLm1hcChhc3luYyBmaWxlID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgdGhpcy5hcHAudmF1bHQucmVhZChmaWxlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gY29udGVudC5pbmNsdWRlcyhsaXN0LnRhZykgPyBmaWxlIDogbnVsbDtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICkpLmZpbHRlcihCb29sZWFuKSBhcyBURmlsZVtdO1xuXG4gICAgICAgIGNvbnN0IGxpbmtzID0gZmlsZXNXaXRoVGFnLm1hcChmaWxlID0+IGBbWyR7ZmlsZS5iYXNlbmFtZX1dXWApLmpvaW4oJ1xcbicpO1xuXG4gICAgICAgIGxldCBub3RlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKGxpc3Qubm90ZVBhdGgpIGFzIFRGaWxlO1xuICAgICAgICBsZXQgY29udGVudCA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LnJlYWQobm90ZSk7XG4gICAgICAgIGNvbnN0IHN0YXJ0QW5jaG9yID0gYDwhLS10YWctbGlzdCAke2xpc3QudGFnfSAke2xpc3QuaWR9LS0+YDtcbiAgICAgICAgY29uc3QgZW5kQW5jaG9yID0gYDwhLS1lbmQtdGFnLWxpc3QgJHtsaXN0LnRhZ30gJHtsaXN0LmlkfS0tPmA7XG4gICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBjb250ZW50LmluZGV4T2Yoc3RhcnRBbmNob3IpO1xuICAgICAgICBjb25zdCBlbmRJbmRleCA9IGNvbnRlbnQuaW5kZXhPZihlbmRBbmNob3IpO1xuICAgICAgICBpZiAoc3RhcnRJbmRleCA+PSAwKSB7XG4gICAgICAgICAgICBpZiAoZW5kSW5kZXggPj0gMCkge1xuICAgICAgICAgICAgICAgIC8vIElmIHRoZSBlbmQgYW5jaG9yIGV4aXN0cywgcmVwbGFjZSB0aGUgY29udGVudCBiZXR3ZWVuIHN0YXJ0IGFuZCBlbmQgYW5jaG9yc1xuICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50LnN1YnN0cmluZygwLCBzdGFydEluZGV4KSArIHN0YXJ0QW5jaG9yICsgXCJcXG5cIiArIGxpbmtzICsgXCJcXG5cIiArIGVuZEFuY2hvciArIGNvbnRlbnQuc3Vic3RyaW5nKGVuZEluZGV4ICsgZW5kQW5jaG9yLmxlbmd0aCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIElmIHRoZSBlbmQgYW5jaG9yIGRvZXMgbm90IGV4aXN0LCBpbnNlcnQgaXQgYWZ0ZXIgdGhlIGxpc3RcbiAgICAgICAgICAgICAgICBjb250ZW50ID0gY29udGVudC5zdWJzdHJpbmcoMCwgc3RhcnRJbmRleCkgKyBzdGFydEFuY2hvciArIFwiXFxuXCIgKyBsaW5rcyArIFwiXFxuXCIgKyBlbmRBbmNob3IgKyBjb250ZW50LnN1YnN0cmluZyhzdGFydEluZGV4ICsgc3RhcnRBbmNob3IubGVuZ3RoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0Lm1vZGlmeShub3RlLCBjb250ZW50KTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuXG5cbiAgYXN5bmMgc2F2ZURhdGEoKSB7XG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIGxpc3RzOiB0aGlzLmxpc3RzLm1hcChsaXN0ID0+ICh7IHRhZzogbGlzdC50YWcsIG5vdGVQYXRoOiBsaXN0Lm5vdGVQYXRoLCBpZDogbGlzdC5pZCB9KSksXG4gIH07XG4gIH1cblxuICBhc3luYyBsb2FkRGF0YSgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LmFkYXB0ZXIucmVhZCgndGFnRmxvd0RhdGEuanNvbicpO1xuICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoY29udGVudCk7XG5cbiAgICAgIHRoaXMubGlzdHMgPSBkYXRhLmxpc3RzLm1hcCgobGlzdERhdGE6IHt0YWc6IHN0cmluZywgbm90ZVBhdGg6IHN0cmluZywgaWQ6IG51bWJlcn0pID0+ICh7IHRhZzogbGlzdERhdGEudGFnLCBub3RlUGF0aDogbGlzdERhdGEubm90ZVBhdGgsIGlkOiBsaXN0RGF0YS5pZCB9KSk7XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBsb2FkIGRhdGE6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBvbnVubG9hZCgpIHtcbiAgICBjb25zb2xlLmxvZygndW5sb2FkaW5nIHBsdWdpbicpO1xuICB9XG59XG4iXSwKICAibWFwcGluZ3MiOiAiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsc0JBQW1GO0FBUW5GLElBQU0sa0JBQU4sY0FBOEIsa0NBQTJCO0FBQUEsRUFHdkQsWUFBWSxLQUFVLFFBQXVCO0FBQzNDLFVBQU0sR0FBRztBQUNULFNBQUssU0FBUztBQUFBLEVBQ2hCO0FBQUEsRUFFQSxXQUFzQjtBQUNwQixVQUFNLGFBQWEsS0FBSyxJQUFJLFVBQVUsb0JBQW9CLDRCQUFZO0FBQ3RFLFdBQU8sYUFBYSxLQUFLLE9BQU8sTUFBTSxPQUFPLFVBQVEsS0FBSyxhQUFhLFdBQVcsS0FBSyxJQUFJLElBQUksQ0FBQztBQUFBLEVBQ2xHO0FBQUEsRUFFQSxZQUFZLE1BQXVCO0FBQ2pDLFlBQVEsSUFBSSxZQUFZLEtBQUssRUFBRTtBQUMvQixXQUFPLEdBQUcsS0FBSyxZQUFZLEtBQUs7QUFBQSxFQUNsQztBQUFBLEVBRUEsYUFBYSxNQUFlO0FBQzFCLFNBQUssT0FBTyxXQUFXLElBQUk7QUFBQSxFQUM3QjtBQUNGO0FBRUEsSUFBTSxlQUFOLGNBQTJCLGtDQUEwQjtBQUFBLEVBSW5ELFlBQVksS0FBVSxRQUF1QixNQUFnQjtBQUMzRCxVQUFNLEdBQUc7QUFDVCxTQUFLLE9BQU87QUFDWixTQUFLLFNBQVM7QUFBQSxFQUNoQjtBQUFBLEVBRUEsV0FBcUI7QUFDbkIsV0FBTyxLQUFLO0FBQUEsRUFDZDtBQUFBLEVB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
